<!DOCTYPE html>
<html class='no-js' xmlns:og='http://ogp.me/ns#'>
<head>
<meta charset='UTF-8' />
<meta content='IE=edge,chrome=1' http-equiv='X-UA-Compatible' />
<meta content='width=device-width, initial-scale=1.0' name='viewport' />
<meta content='/stuff/shake.html' property='og:title' />
<meta content='blog' property='og:type' />
<meta content='RicoStaCruz.com' property='og:site_name' />
<meta content='169204529787544' property='fb:app_id' />
<meta content='ricostacruz' property='fb:admins' />
<title>/stuff/shake.html</title>
<link href='/css/style.css' media='screen' rel='stylesheet' type='text/css' />
<link href='/css/special.css' media='screen' rel='stylesheet' type='text/css' />
<link href='/favicon.png' rel='shortcut icon' type='text/css' />
<link href='http://fonts.googleapis.com/css?family=Droid+Sans:regular,bold' rel='stylesheet' type='text/css' />
<link href='http://feeds.feedburner.com/ricostacruz' rel='alternate' title='RicoStaCruz.com' type='application/rss+xml' />
<script type='text/javascript'>
  //<![CDATA[
    var _gaq = _gaq || [];
    _gaq.push(['_setAccount', 'UA-20473929-1']);
    _gaq.push(['_trackPageview']);
    
    (function() {
      var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
      ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
    })();
  //]]>
</script>

</head>
<body class='page-'>
<!DOCTYPE html>
<html>
<head>
  <meta http-equiv="content-type" content="text/html;charset=utf-8">
  <title>shake_rocco.rb</title>
  <link rel="stylesheet" href="http://jashkenas.github.com/docco/resources/docco.css">
</head>
<body>
<div id='container'>
  <div id="background"></div>
  <table cellspacing=0 cellpadding=0>
  <thead>
    <tr>
      <th class=docs><h1>shake_rocco.rb</h1></th>
      <th class=code></th>
    </tr>
  </thead>
  <tbody>
    <tr id='section-1'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-1">#</a>
        </div>
        <h1>Shake</h1>

<p> Shake is a very simple Thor/Rake replacement. It intends
 to replicate thor&rsquo;s basic functionality in &lt;100loc.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre></pre></div>
      </td>
    </tr>
    <tr id='section-2'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-2">#</a>
        </div>
        <h2>Example</h2>

<p> This is a very simple example.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><span class="nb">require</span> <span class="s1">&#39;shake&#39;</span>

<span class="no">Shake</span><span class="o">.</span><span class="n">task</span><span class="p">(</span><span class="ss">:hello</span><span class="p">)</span> <span class="p">{</span>
  <span class="nb">puts</span> <span class="s2">&quot;hi, </span><span class="si">#{</span><span class="n">params</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">)</span><span class="si">}</span><span class="s2">!&quot;</span>
<span class="p">}</span>

<span class="no">Shake</span><span class="o">.</span><span class="n">run!</span></pre></div>
      </td>
    </tr>
    <tr id='section-3'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-3">#</a>
        </div>
        <p> Example output:</p>

<pre><code>$ ./example
Usage: example &lt;command&gt;

Commands:
  help
  hello

$ ./example hello world
hi, world!

$ ./example aaaa
Unknown command: aaaa
See `example help` for a list of commands.
</code></pre>
      </td>
      <td class=code>
        <div class='highlight'><pre></pre></div>
      </td>
    </tr>
    <tr id='section-4'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-4">#</a>
        </div>
        <h2>Example 2: monk</h2>

<p> This is a very simple example of using Shake with a subclass.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><span class="nb">require</span> <span class="s1">&#39;shake&#39;</span>

<span class="k">class</span> <span class="nc">Monk</span> <span class="o">&lt;</span> <span class="no">Shake</span></pre></div>
      </td>
    </tr>
    <tr id='section-5'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-5">#</a>
        </div>
        <p> Include the Shake default commands (like <code>help</code> and stuff)
 This is optional, but you probably want this for most cases.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>  <span class="kp">include</span> <span class="no">Defaults</span></pre></div>
      </td>
    </tr>
    <tr id='section-6'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-6">#</a>
        </div>
        <p> Define a task like this.
 The other command line options will be accesible as the
 <code>params</code> array. Pass it onto Clap or something.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>  <span class="n">task</span><span class="p">(</span><span class="ss">:start</span><span class="p">)</span> <span class="p">{</span>
    <span class="nb">puts</span> <span class="s2">&quot;Running...&quot;</span>
    <span class="nb">puts</span> <span class="s2">&quot;Your options: </span><span class="si">#{</span><span class="n">params</span><span class="o">.</span><span class="n">inspect</span><span class="si">}</span><span class="s2">&quot;</span>
  <span class="p">}</span></pre></div>
      </td>
    </tr>
    <tr id='section-7'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-7">#</a>
        </div>
        <p> Just <code>task</code> will return the last defined task.
 By the way, only <code>help</code> cares about the description (skip
 it if you wish), and you can add as much metadata to the
 tasks as you need.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>  <span class="n">task</span><span class="o">.</span><span class="n">description</span> <span class="o">=</span> <span class="s2">&quot;Starts the server&quot;</span></pre></div>
      </td>
    </tr>
    <tr id='section-8'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-8">#</a>
        </div>
        <p> You may also define task metadata like this.
 Note that there are no namespaces, but feel free to use
 the colon anyway.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>  <span class="n">task</span><span class="p">(</span><span class="ss">:&#39;redis:start&#39;</span><span class="p">,</span> <span class="ss">:description</span> <span class="o">=&gt;</span> <span class="s2">&quot;Runs redis&quot;</span><span class="p">)</span> <span class="p">{</span>
    <span class="nb">puts</span> <span class="s2">&quot;Starting redis...&quot;</span>
  <span class="p">}</span></pre></div>
      </td>
    </tr>
    <tr id='section-9'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-9">#</a>
        </div>
        <p> Or this way:</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>  <span class="n">task</span><span class="p">(</span><span class="ss">:stop</span><span class="p">)</span> <span class="p">{</span>
    <span class="nb">puts</span> <span class="s2">&quot;Stopping...&quot;</span>
  <span class="p">}</span>

  <span class="n">task</span><span class="p">(</span><span class="ss">:stop</span><span class="p">)</span><span class="o">.</span><span class="n">description</span> <span class="o">=</span> <span class="s2">&quot;Stops the server&quot;</span>
<span class="k">end</span></pre></div>
      </td>
    </tr>
    <tr id='section-10'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-10">#</a>
        </div>
        <p> This gets ARGV, and dispatches the appropriate task.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><span class="no">Monk</span><span class="o">.</span><span class="n">run!</span></pre></div>
      </td>
    </tr>
    <tr id='section-11'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-11">#</a>
        </div>
        <p> Example output:</p>

<pre><code>$ ./monk
Usage: monk &lt;command&gt;

Commands:
  help           Shows a list of commands
  start          Starts the server
  redis:start    Runs redis
  stop           Stops the server

$ ./monk start production
Running...
Your options: ['production']

$ ./monk aaaa
Unknown command: aaaa
See `monk help` for a list of commands.
</code></pre>
      </td>
      <td class=code>
        <div class='highlight'><pre></pre></div>
      </td>
    </tr>
    <tr id='section-12'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-12">#</a>
        </div>
        <h1>shake.rb</h1>

<p> Now onto Shake itself!</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><span class="nb">require</span> <span class="s1">&#39;ostruct&#39;</span>

<span class="k">class</span> <span class="nc">Shake</span></pre></div>
      </td>
    </tr>
    <tr id='section-13'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-13">#</a>
        </div>
        <p> By the way: every task gets evaluated in the context of the class.
 Just make more static methods (<code>def self.monkey</code>) if you need them
 in your tasks.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>  <span class="k">class</span> <span class="o">&lt;&lt;</span> <span class="nb">self</span>
    <span class="kp">attr_reader</span> <span class="ss">:params</span>
    <span class="kp">attr_reader</span> <span class="ss">:command</span></pre></div>
      </td>
    </tr>
    <tr id='section-14'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-14">#</a>
        </div>
        <p> Returns a list of tasks.
 It gives out a hash with symbols as keys, and openstructs as values.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>    <span class="k">def</span> <span class="nf">tasks</span>
      <span class="vi">@tasks</span> <span class="o">||=</span> <span class="no">Hash</span><span class="o">.</span><span class="n">new</span>
    <span class="k">end</span></pre></div>
      </td>
    </tr>
    <tr id='section-15'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-15">#</a>
        </div>
        <p> Sets or retrieves a task.
 If no arguments are given, it returns the last task defined.</p>

<p> Examples:</p>

<pre><code> task(:start) { ... }
 task(:start, description: 'Starts it') { ... }
 invoke task(:start)
 task.description = "Starts it"
</code></pre>
      </td>
      <td class=code>
        <div class='highlight'><pre>    <span class="k">def</span> <span class="nf">task</span><span class="p">(</span><span class="n">what</span><span class="o">=</span><span class="kp">nil</span><span class="p">,</span> <span class="n">options</span><span class="o">=</span><span class="p">{},</span> <span class="o">&amp;</span><span class="n">blk</span><span class="p">)</span>
      <span class="k">return</span> <span class="vi">@last</span>  <span class="k">if</span> <span class="n">what</span><span class="o">.</span><span class="n">nil?</span>

      <span class="n">key</span> <span class="o">=</span> <span class="n">what</span><span class="o">.</span><span class="n">downcase</span><span class="o">.</span><span class="n">to_sym</span>
      <span class="vi">@last</span> <span class="o">=</span> <span class="n">tasks</span><span class="o">[</span><span class="n">key</span><span class="o">]</span> <span class="o">=</span> <span class="n">new_task</span><span class="p">(</span><span class="n">options</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">blk</span><span class="p">)</span>  <span class="k">if</span> <span class="nb">block_given?</span>
      <span class="n">tasks</span><span class="o">[</span><span class="n">key</span><span class="o">]</span>
    <span class="k">end</span></pre></div>
      </td>
    </tr>
    <tr id='section-16'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-16">#</a>
        </div>
        <p> Sets or retrieves the default task.</p>

<p> Examples:</p>

<pre><code> default :default_task
 default { ... }
</code></pre>
      </td>
      <td class=code>
        <div class='highlight'><pre>    <span class="k">def</span> <span class="nf">default</span><span class="p">(</span><span class="n">what</span><span class="o">=</span><span class="kp">nil</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">blk</span><span class="p">)</span>
      <span class="vi">@default</span> <span class="o">=</span> <span class="n">what</span> <span class="o">||</span> <span class="n">blk</span> <span class="o">||</span> <span class="vi">@default</span>
    <span class="k">end</span></pre></div>
      </td>
    </tr>
    <tr id='section-17'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-17">#</a>
        </div>
        <p> Sets or retrieves the &lsquo;invalid command&rsquo; task.
 See <code>default</code> for examples.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>    <span class="k">def</span> <span class="nf">invalid</span><span class="p">(</span><span class="n">what</span><span class="o">=</span><span class="kp">nil</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">blk</span><span class="p">)</span>
      <span class="vi">@invalid</span> <span class="o">=</span> <span class="n">what</span> <span class="o">||</span> <span class="n">blk</span> <span class="o">||</span> <span class="vi">@invalid</span>
    <span class="k">end</span></pre></div>
      </td>
    </tr>
    <tr id='section-18'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-18">#</a>
        </div>
        <p> Invokes a task with the given arguments.
 You may even nest multiple task invocations.</p>

<p> Examples:</p>

<pre><code>invoke(:start)
invoke(:start, 'nginx', 'memcache')
</code></pre>
      </td>
      <td class=code>
        <div class='highlight'><pre>    <span class="k">def</span> <span class="nf">invoke</span><span class="p">(</span><span class="n">what</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">)</span>
      <span class="n">old</span><span class="p">,</span> <span class="vi">@params</span> <span class="o">=</span> <span class="vi">@params</span><span class="p">,</span> <span class="n">args</span>

      <span class="k">begin</span>
        <span class="k">return</span> <span class="nb">instance_eval</span><span class="p">(</span><span class="o">&amp;</span><span class="n">what</span><span class="p">)</span>  <span class="k">if</span> <span class="n">what</span><span class="o">.</span><span class="n">is_a?</span><span class="p">(</span><span class="no">Proc</span><span class="p">)</span>

        <span class="n">task</span>  <span class="o">=</span> <span class="n">task</span><span class="p">(</span><span class="n">what</span><span class="p">)</span>  <span class="ow">or</span> <span class="k">return</span> <span class="kp">nil</span>
        <span class="nb">instance_eval</span> <span class="o">&amp;</span><span class="n">task</span><span class="o">.</span><span class="n">proc</span>
        <span class="kp">true</span>
      <span class="k">ensure</span>
        <span class="vi">@params</span> <span class="o">=</span> <span class="n">old</span>
      <span class="k">end</span>
    <span class="k">end</span></pre></div>
      </td>
    </tr>
    <tr id='section-19'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-19">#</a>
        </div>
        <p> Runs with the given arguments and dispatches the appropriate task.
 Use <code>run!</code> if you want to go with command line arguments.</p>

<p> Example:</p>

<pre><code> # This is equivalent to `invoke(:start, 'nginx')`
 run 'start', 'nginx'
</code></pre>
      </td>
      <td class=code>
        <div class='highlight'><pre>    <span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="o">*</span><span class="n">argv</span><span class="p">)</span>
      <span class="k">return</span> <span class="n">invoke</span><span class="p">(</span><span class="n">default</span><span class="p">)</span>  <span class="k">if</span> <span class="n">argv</span><span class="o">.</span><span class="n">empty?</span>

      <span class="vi">@command</span> <span class="o">=</span> <span class="n">argv</span><span class="o">.</span><span class="n">shift</span>
      <span class="n">invoke</span><span class="p">(</span><span class="vi">@command</span><span class="p">,</span> <span class="o">*</span><span class="n">argv</span><span class="p">)</span> <span class="ow">or</span> <span class="n">invoke</span><span class="p">(</span><span class="n">invalid</span><span class="p">)</span>
    <span class="k">end</span>

    <span class="k">def</span> <span class="nf">run!</span>
      <span class="n">run</span> <span class="o">*</span><span class="no">ARGV</span>
    <span class="k">end</span>

    <span class="k">def</span> <span class="nf">executable</span>
      <span class="no">File</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="vg">$0</span><span class="p">)</span>
    <span class="k">end</span>

    <span class="k">def</span> <span class="nf">err</span><span class="p">(</span><span class="n">str</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">)</span>
      <span class="vg">$stderr</span><span class="o">.</span><span class="n">write</span> <span class="s2">&quot;</span><span class="si">#{</span><span class="n">str</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span>
    <span class="k">end</span>

  <span class="kp">protected</span>
    <span class="k">def</span> <span class="nf">new_task</span><span class="p">(</span><span class="n">options</span><span class="o">=</span><span class="p">{},</span> <span class="o">&amp;</span><span class="n">blk</span><span class="p">)</span>
      <span class="n">t</span> <span class="o">=</span> <span class="no">OpenStruct</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="n">options</span><span class="p">)</span>
      <span class="n">t</span><span class="o">.</span><span class="n">proc</span> <span class="o">=</span> <span class="n">blk</span>
      <span class="n">t</span>
    <span class="k">end</span>
  <span class="k">end</span></pre></div>
      </td>
    </tr>
    <tr id='section-20'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-20">#</a>
        </div>
        <p> This is a list of default commands.
 The class Shake itself uses this, but if you subclass it,
 you will have to do <code>include Defaults</code> yourself.</p>

      </td>
      <td class=code>
        <div class='highlight'><pre>  <span class="k">module</span> <span class="nn">Defaults</span>
    <span class="k">def</span> <span class="nc">self</span><span class="o">.</span><span class="nf">included</span><span class="p">(</span><span class="n">to</span><span class="p">)</span>
      <span class="n">to</span><span class="o">.</span><span class="n">default</span> <span class="ss">:help</span>

      <span class="n">to</span><span class="o">.</span><span class="n">task</span><span class="p">(</span><span class="ss">:help</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">err</span> <span class="s2">&quot;Usage: </span><span class="si">#{</span><span class="n">executable</span><span class="si">}</span><span class="s2"> &lt;command&gt;&quot;</span>
        <span class="n">err</span>
        <span class="n">err</span> <span class="s2">&quot;Commands:&quot;</span>
        <span class="n">tasks</span><span class="o">.</span><span class="n">each</span> <span class="p">{</span> <span class="o">|</span><span class="nb">name</span><span class="p">,</span> <span class="n">task</span><span class="o">|</span> <span class="n">err</span> <span class="s2">&quot;  %-20s %s&quot;</span> <span class="o">%</span> <span class="o">[</span> <span class="nb">name</span><span class="p">,</span> <span class="n">task</span><span class="o">.</span><span class="n">description</span> <span class="o">]</span> <span class="p">}</span>
      <span class="p">}</span>

      <span class="n">to</span><span class="o">.</span><span class="n">task</span><span class="p">(</span><span class="ss">:help</span><span class="p">)</span><span class="o">.</span><span class="n">description</span> <span class="o">=</span> <span class="s2">&quot;Shows a list of commands&quot;</span>

      <span class="n">to</span><span class="o">.</span><span class="n">invalid</span> <span class="p">{</span>
        <span class="n">err</span> <span class="s2">&quot;Unknown command: </span><span class="si">#{</span><span class="n">command</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="n">err</span> <span class="s2">&quot;See `</span><span class="si">#{</span><span class="n">executable</span><span class="si">}</span><span class="s2"> help` for a list of commands.&quot;</span>
      <span class="p">}</span>
    <span class="k">end</span>
  <span class="k">end</span>

  <span class="kp">include</span> <span class="no">Defaults</span>
<span class="k">end</span></pre></div>
      </td>
    </tr>
  </table>
</div>
</body>

<script src='http://cachedcommons.org/cache/prettify/1.0.0/javascripts/prettify-min.js' type='text/javascript'></script>
<script type='text/javascript'>
  //<![CDATA[
    prettyPrint();
  //]]>
</script>
</body>
</html>
